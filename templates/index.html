<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sigorta Admin Paneli</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --main: #667eea;
      --main-dark: #4b5aba;
      --accent: #b8c4ff;
      --success: #46c07c;
      --danger: #e93939;
      --info: #17a2b8;
      --surface: #fff;
      --shadow: 0 4px 20px rgba(0,0,0,0.09);
    }
    * { box-sizing: border-box;}
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #e7eafc 0%, #f6f7fa 100%);
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1080px;
      margin: 28px auto;
      padding: 0 10px;
    }
    .card, .content-card {
      background: var(--surface);
      border-radius: 22px;
      margin-bottom: 26px;
      box-shadow: var(--shadow);
      padding: 34px 28px 32px 28px;
      border: none;
      position: relative;
    }
    .admin-header {
      background: linear-gradient(100deg, var(--main) 0%, var(--main-dark) 100%);
      color: #fff;
      border-radius: 20px;
      padding: 34px 24px 34px 168px;
      position: relative;
      margin-bottom: 38px;
      overflow: hidden;
      min-height: 105px;
    }
    .admin-header img {
      position: absolute;
      left: 36px; top: 26px;
      width: 98px; height: 98px;
      border-radius: 50%;
      background: #fff;
      object-fit: contain;
      border: 2.5px solid #fff;
      box-shadow: 0 4px 30px rgba(80,112,241,0.10);
    }
    .admin-header h1 {
      font-size: 2.5em;
      font-weight: 800;
      margin: 0 0 8px 0;
      text-shadow: 0 3px 8px rgba(60,60,80,.13);
      line-height: 1.1;
    }
    .admin-header p { margin: 0; opacity: .96; font-size: 1.19em;}
    @media (max-width:800px) {
      .container { padding: 0 2vw; }
      .admin-header { padding-left: 30px; min-height: 70px;}
      .admin-header img { position: static; display: block; margin: 0 auto 14px auto; }
      .admin-header h1 { font-size: 1.7em;}
    }

    /* Navbar */
    .nav {
      display: flex; flex-wrap: wrap; gap: 10px 12px; margin: 0 0 18px;
      justify-content: flex-end;
      align-items: center;
    }
    .nav a, .nav button {
      background: #f4f6fb;
      color: #4254a8;
      font-weight: 600;
      border: none;
      padding: 12px 24px;
      border-radius: 14px;
      font-size: 1em;
      cursor: pointer;
      transition: all .21s;
      text-decoration: none;
      box-shadow: 0 2px 7px rgba(102,126,234,0.06);
      display: flex; align-items: center; gap: 6px;
    }
    .nav a.nav-active,
    .nav a:hover, .nav button:hover {
      background: var(--main);
      color: #fff;
      transform: translateY(-2.5px) scale(1.02);
      box-shadow: 0 7px 22px rgba(102,126,234,0.05);
    }
    @media (max-width:600px) {
      .nav { flex-direction: column; align-items: stretch; }
      .nav a, .nav button { width: 100%; text-align: left; margin: 0; border-radius:10px; }
    }

    /* Stat boxes */
    .stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 18px;
      justify-content: center;
    }
    .stat-box {
      flex: 1 1 100px;
      min-width: 170px;
      max-width: 260px;
      background: linear-gradient(120deg, var(--main) 0%, #86b7fe 100%);
      color: #fff;
      border-radius: 14px;
      padding: 28px 14px 18px 16px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(70,100,200,0.07);
      position: relative;
    }
    .stat-box .icon { font-size: 2.2em; opacity: 0.84; margin-bottom: 8px; }
    .stat-box .num { font-size: 2.1em; font-weight: 700; margin-bottom: 2px; letter-spacing: 0.01em;}
    .stat-box .label { letter-spacing: .03em; opacity:.98;}
    @media (max-width:600px) {
      .stats { flex-direction: column; gap: 12px;}
      .stat-box { max-width: none; }
    }

    /* Logo y√∂netimi */
    .logo-manage-flex {
      display: flex; gap: 28px; flex-wrap: wrap;
    }
    .logo-card {
      background: #fafdff;
      padding: 28px 12px;
      border-radius: 12px;
      flex: 1 1 260px;
      min-width: 220px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(100,120,200,.08);
      margin-bottom: 12px;
    }
    .logo-card .logo-block {
      min-height: 120px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 9px;
    }
    .logo-card img {
      max-width: 160px; max-height: 120px; display: block; margin: 0 auto;
      background: #fff; border-radius: 7px; border: 1.5px solid #eef1ff;
      object-fit: contain;
      padding: 10px;
    }
    .logo-card .btn-danger { margin-top: 10px;}
    @media (max-width:700px) {
      .logo-manage-flex { flex-direction: column;}
      .logo-card { min-width: unset;}
    }

    /* Upload alanƒ± */
    .upload-area {
      border: 3px dashed #dee2e6;
      border-radius: 14px;
      padding: 38px 12px;
      text-align: center;
      background: #f3f6fe;
      transition: all 0.22s;
      cursor: pointer;
      color: #555;
      font-weight: 600;
      margin-bottom: 14px;
    }
    .upload-area:hover {
      border-color: var(--main);
      background: #e7f0ff;
      transform: scale(1.011);
    }
    .upload-icon {
      font-size: 2.5em; color: #7d89cb; margin-bottom: 16px; display: block;
    }

    /* Action buttons */
    .action-buttons {
      display: flex; flex-wrap: wrap; gap: 14px; margin: 17px 0 0 0;
      justify-content: center;
    }
    .action-buttons .btn { background: var(--main); color: #fff; font-weight:700; }
    .action-buttons .btn-secondary { background: var(--info); color: #fff;}
    .action-buttons .btn-danger { background: var(--danger);}
    .action-buttons .btn:hover { background: var(--main-dark);}
    .action-buttons .btn-secondary:hover { background: #097589; }
    .action-buttons .btn-danger:hover { background: #b51212; }

    /* Selects and forms */
    select, input[type="file"], input[type="text"] {
      padding: 13px;
      font-size: 1.06em;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      margin-bottom: 5px;
      background: #fafbff;
      transition: border .18s;
    }
    select:focus, input[type="file"]:focus, input[type="text"]:focus {
      border-color: var(--main);
      outline: none;
    }

    label { font-weight: 600; color: var(--main-dark);}
    .subtitle { text-align: center; color: #6f7da8; margin-bottom: 30px; }

    /* Fiyat tablo */
    .compare-table-cards {
      margin-top: 18px;
      display: grid; gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .compare-card {
      background: #f7faff;
      border: 2px solid #eaefff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(80,120,255,0.04);
      text-align: center;
      padding: 24px 6px;
      transition: box-shadow .19s, transform .15s;
    }
    .compare-card:hover {
      box-shadow: 0 10px 30px rgba(102,126,234,0.12);
      transform: scale(1.016);
      border-color: #b8c4ff;
    }
    .compare-card .company {
      font-size: 1.16em;
      font-weight: 700;
      color: #4254a8;
    }
    .compare-card .price {
      font-size: 2em;
      color: var(--success);
      font-weight: 800;
      margin: 11px 0 0 0;
    }

    .list-inline {
      display: flex; flex-wrap: wrap; gap: 7px; margin: 12px 0 0 0;
    }
    .inline-item {
      background: #fafbff;
      border-radius: 8px;
      padding: 6px 16px;
      font-weight: 600;
      color: #4358b8;
      font-size: 0.98em;
      border: 1.5px solid #eaeefa;
    }
    /* Alert/Flash */
    .alert {
      padding: 16px 24px;
      border-radius: 13px;
      margin-bottom: 20px;
      font-weight: 600;
      animation: slideIn 0.5s;
      font-size:1.12em;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0;}
      to{ transform: translateY(0); opacity: 1;}
    }
    .alert-success {
      background: #eaffea;
      color: #287d38;
      border-left: 5px solid #2dba53;
    }
    .alert-error {
      background: #fbe9e9;
      color: #ba3939;
      border-left: 5px solid #e93939;
    }
    /* YATAY KAYABƒ∞LEN tablo/alan */
    .scroll-x { overflow-x: auto; }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="admin-header">
      <img id="panelLogo" src="" alt="Logo" />
      <h1>SigortaApp Y√∂netim Paneli</h1>
      <p>Verilerinizi, fiyat tablolarƒ±nƒ±zƒ± ve logonuzu buradan y√∂netin</p>
    </div>

    <!-- Navigation -->
    <div class="nav">
      <a href="/" class="">üè° Ana Sayfa</a>
      <a href="/view">üìã Kayƒ±tlarƒ± G√∂r√ºnt√ºle</a>
      <a href="/api/vehicles" target="_blank">üîó JSON API</a>
      <a href="/admin-panel" class="nav-active">üõ°Ô∏è Admin Kontrol</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- LOGO Y√ñNETIMI -->
    <div class="content-card">
      <h2 style="margin-top:0;">üñºÔ∏è Logo Y√∂netimi</h2>
      <p class="subtitle" style="margin-top:-8px;">Firmanƒ±zƒ±n logosunu y√ºkleyin/deƒüi≈ütirin.</p>
      <div class="logo-manage-flex">
        <div class="logo-card">
          <div class="logo-block" id="logoPreview">
            <span style="color:#b7bdcb;">Logo yok</span>
          </div>
        </div>
        <div class="logo-card">
          <form action="/admin/upload-logo" method="post" enctype="multipart/form-data" style="margin-bottom:10px;">
            <label for="logoInput">üìÅ Yeni Logo Se√ßin:</label><br>
            <input
              type="file"
              name="logo"
              id="logoInput"
              accept="image/*"
              style="width: 100%;"
              onchange="previewLogo(this)"
              required>
            <div class="action-buttons" style="margin: 17px 0 0 0;">
              <button type="submit" class="btn">‚úÖ Y√ºkle</button>
              <button type="button" class="btn btn-danger" onclick="deleteLogo()" style="margin-left: 6px;">üóëÔ∏è Sil</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ƒ∞STATƒ∞STƒ∞K KARTLARI -->
    <div class="stats">
      <div class="stat-box">
        <div class="icon">üìÑ</div>
        <div class="num">{{ total_records }}</div>
        <div class="label">Toplam Kayƒ±t</div>
      </div>
      <div class="stat-box">
        <div class="icon">üöó</div>
        <div class="num">{{ unique_brands }}</div>
        <div class="label">Benzersiz Marka</div>
      </div>
      <div class="stat-box">
        <div class="icon">üè¢</div>
        <div class="num">{{ sigorta_sirketleri|length }}</div>
        <div class="label">Sigorta ≈ûirketi</div>
      </div>
    </div>

    {% if sigorta_sirketleri %}
    <div class="list-inline" style="margin-bottom:20px;">
      <span style="font-weight:600;">üí° A√ßƒ±ktaki Sigorta ≈ûirketleri:</span>
      {% for sirket in sigorta_sirketleri %}
        <span class="inline-item">{{ sirket }}</span>
      {% endfor %}
    </div>
    {% endif %}

    <!-- EXCEL UPLOAD -->
    <div class="content-card">
      <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
        <label for="fileInput" class="upload-area" id="uploadLabel">
          <span class="upload-icon">üìÅ</span>
          <span style="font-size:1.13em;">Excel Dosyasƒ± Y√ºkle (Trafik Sigorta Tablosu)</span>
          <br>
          <span style="font-size:.98em; color:#667eea;">Format: Marka | Model | Yƒ±l | ≈ûirket1 | ≈ûirket2...</span>
          <input type="file" name="file" id="fileInput" accept=".xlsx,.xls" required>
        </label>
        <div id="fileName" style="margin:9px 0 0 1px; color: #667eea; font-weight: 600;"></div>
        <div class="action-buttons">
          <button type="submit" class="btn">‚úÖ Y√ºkle & ƒ∞≈üle</button>
          <a href="/view" class="btn btn-secondary">üìä Kayƒ±t Tablosu</a>
          <a href="/api/vehicles" class="btn btn-secondary" target="_blank">üîó JSON API</a>
          <button type="button" class="btn btn-danger" onclick="confirmClear()">üóëÔ∏è T√ºm√ºn√º Sil</button>
        </div>
      </form>
    </div>

    <!-- KAR≈ûILA≈ûTIRMA -->
    <div class="content-card">
      <h2 style="margin-top:0;">üîç Fiyat Kar≈üƒ±la≈ütƒ±r</h2>
      <p class="subtitle">Marka, yƒ±l ve modeli se√ßerek kolayca fiyatlarƒ± g√∂r.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px 24px; margin-bottom:22px;">
        <div>
          <label>Marka:</label>
          <select id="markaSelect"><option value="">Marka Se√ßiniz</option></select>
        </div>
        <div>
          <label>Yƒ±l:</label>
          <select id="yilSelect" disabled><option value="">√ñnce marka</option></select>
        </div>
        <div>
          <label>Model:</label>
          <select id="modelSelect" disabled><option value="">√ñnce yƒ±l</option></select>
        </div>
      </div>
      <div class="action-buttons" style="margin-top:10px;">
        <button id="karsilastirBtn" class="btn" disabled onclick="karsilastir()">üí∞ Fiyatlarƒ± Kar≈üƒ±la≈ütƒ±r</button>
      </div>
      <div id="sonuclar" style="display:none; margin-top:28px;">
        <div id="fiyatTablosu"></div>
      </div>
    </div>
  </div>
  <form id="clearForm" action="/clear" method="post" style="display: none;"></form>
  <script>
    // LOGO y√ºkle/g√∂ster/sil
    function showCurrentLogo() {
      fetch('/api/logo')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.logo_url)
            document.getElementById('panelLogo').src = data.logo_url+"?t="+Date.now(),
            document.getElementById('logoPreview').innerHTML =
              `<img src="${data.logo_url}?t=${Date.now()}" alt="Mevcut Logo">`;
          else {
            document.getElementById('logoPreview').innerHTML = '<span style="color:#bbb;">Logo yok</span>';
            document.getElementById('panelLogo').src = "https://ui-avatars.com/api/?name=SigortaApp&background=667eea&color=fff";
          }
        })
    }
    window.addEventListener('DOMContentLoaded', showCurrentLogo);
    function previewLogo(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('logoPreview').innerHTML =
            `<img src="${e.target.result}" alt="Logo √ñnizleme">`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    function deleteLogo() {
      if (confirm('Logoyu silmek istediƒüinize emin misiniz?'))
        fetch('/admin/delete-logo', {method: 'POST'}).then(()=>window.location.reload());
    }

    // Dosya se√ßilince adƒ±nƒ± yaz
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const f = e.target.files[0];
      document.getElementById('fileName').textContent = f ? `Se√ßildi: ${f.name}` : '';
    });

    // Temizle onayƒ±
    function confirmClear() {
      if (confirm('‚ö†Ô∏è T√ºm veriler silinecek. Emin misiniz?'))
        document.getElementById('clearForm').submit();
    }

    // Excel upload alanƒ± drag/drop styling
    const uploadArea = document.getElementById('uploadLabel');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault(); uploadArea.style.borderColor = "#667eea"; uploadArea.style.background = "#e7f0ff";
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = "#dee2e6"; uploadArea.style.background = "#f3f6fe";
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault(); const file = e.dataTransfer.files[0];
      document.getElementById('fileInput').files = e.dataTransfer.files;
      document.getElementById('fileName').textContent = `Se√ßildi: ${file.name}`;
      uploadArea.style.borderColor = "#667eea";
    });

    // Fiyat filtreleri dinamik
    document.addEventListener('DOMContentLoaded', ()=>{
      fetch('/api/brands').then(res=>res.json()).then(brands=>{
        const markaSelect=document.getElementById('markaSelect');
        brands.forEach(brand=>{
          const o=document.createElement('option');
          o.value=brand; o.textContent=brand; markaSelect.appendChild(o);
        });
      });
    });
    document.getElementById('markaSelect').addEventListener('change', function() {
      const m=this.value, yilSelect=document.getElementById('yilSelect'), modelSelect=document.getElementById('modelSelect');
      yilSelect.innerHTML='<option value="">Yƒ±l Se√ßiniz</option>'; modelSelect.innerHTML='<option value="">√ñnce yƒ±l</option>';
      yilSelect.disabled=!m; modelSelect.disabled=true;
      if(m) fetch(`/api/years/${m}`).then(r=>r.json()).then(years=>{
        years.forEach(y=>{
          const o=document.createElement('option'); o.value=y;o.textContent=y;yilSelect.appendChild(o);
        });
      });
    });
    document.getElementById('yilSelect').addEventListener('change', function() {
      const m=document.getElementById('markaSelect').value, y=this.value, modelSelect=document.getElementById('modelSelect');
      modelSelect.innerHTML='<option value="">Model Se√ßiniz</option>'; modelSelect.disabled=!y;
      if(m&&y)fetch(`/api/models/${m}/${y}`).then(r=>r.json()).then(models=>{
        models.forEach(model=>{
          const o=document.createElement('option'); o.value=model; o.textContent=model; modelSelect.appendChild(o);
        });
      });
    });
    document.getElementById('modelSelect').addEventListener('change', function() {
      document.getElementById('karsilastirBtn').disabled=!this.value;
    });

    function karsilastir() {
      const m=document.getElementById('markaSelect').value,
        y=document.getElementById('yilSelect').value,
        mo=document.getElementById('modelSelect').value;
      fetch(`/api/vehicle/${m}/${mo}/${y}`)
      .then(r=>r.json()).then(data=>{
        if(data.success){
          const v=data.data, t=document.getElementById('fiyatTablosu');
          let html=`
            <div style="text-align:center;margin-bottom:17px;">
              <span style="font-size:1.14em;color:var(--main);font-weight:800;">${v.marka} ${v.model} (${v.yil})</span>
            </div>
            <div class="compare-table-cards">
          `;
          Object.entries(v.sigortalar).sort(([,a],[,b])=>a-b).forEach(([sirket,fiyat])=>{
            html+=`
            <div class="compare-card">
              <div class="company">${sirket}</div>
              <div class="price">${fiyat.toLocaleString('tr-TR')} ‚Ç∫</div>
            </div>`;
          });
          html+='</div>';
          t.innerHTML=html;
          document.getElementById('sonuclar').style.display='block';
        }
      });
    }
  </script>
</body>
</html>